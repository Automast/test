CheckoutSummary.tsx
// productcomponents/CheckoutSummary.tsx
'use client';

import { IProduct, IVariantSelection } from '../productlib/types';
import { formatPrice } from '../productlib/currency';
import { calculateTotalPrice } from '../productlib/utils';

interface CheckoutSummaryProps {
  product: IProduct;
  quantity: number;
  variantSelections: IVariantSelection[];
  selectedShipping?: string;
  localCurrency?: string;
}

// Define an extended product type that explicitly includes our local currency properties
interface ProductWithLocalCurrency extends IProduct {
  localPrice?: number;
  localCurrency?: string;
}

const CheckoutSummary: React.FC<CheckoutSummaryProps> = ({
  product,
  quantity,
  variantSelections,
  selectedShipping,
  localCurrency
}) => {
  // Cast product to our extended type to avoid TypeScript errors
  const productWithLocal = product as ProductWithLocalCurrency;
  
  // Use product local price if available, or fall back to original price
  const displayPrice = productWithLocal.localPrice !== undefined ? productWithLocal.localPrice : product.price;
  
  // Use product local currency if available, or fall back to default currency
  const displayCurrency = productWithLocal.localCurrency || 
    (localCurrency && product.autoLocalPrice ? localCurrency : product.defaultCurrency);
  
  // Determine if we need to convert prices
  const needsConversion = 
    productWithLocal.localPrice !== undefined && 
    productWithLocal.localCurrency !== undefined && 
    productWithLocal.localCurrency !== product.defaultCurrency;
  
  // Calculate with original price first
  const originalPrices = calculateTotalPrice(
    product,  // Using the original product
    quantity, 
    selectedShipping
  );
  
  // If conversion is needed, apply the same conversion rate to all components
  let { subtotal, vat, shipping, total } = originalPrices;
  
  if (needsConversion && productWithLocal.localPrice !== undefined) {
    // Calculate conversion rate based on single item price
    const conversionRate = productWithLocal.localPrice / product.price;
    
    // Apply conversion to all price components
    subtotal = parseFloat((originalPrices.subtotal * conversionRate).toFixed(2));
    vat = parseFloat((originalPrices.vat * conversionRate).toFixed(2));
    shipping = parseFloat((originalPrices.shipping * conversionRate).toFixed(2));
    total = parseFloat((subtotal + vat + shipping).toFixed(2));
  }

  const formatImageUrl = (url: string): string => {
    // If it's already a full URL, use it as-is
    if (url.startsWith('http')) {
      return url;
    }
    
    // Make sure URLs that start with /uploads have the proper /api prefix
    if (url.startsWith('/uploads') && !url.startsWith('/api/uploads')) {
      return `/api${url}`;
    }
    
    // URLs that already have /api/uploads are good
    if (url.startsWith('/api/uploads')) {
      return url;
    }
    
    // For all other cases, ensure it has the complete path
    return `/api/uploads/${url.replace(/^\//, '')}`;
  };
  
  return (
    <>
      <style jsx>{`
        .product-details {
          background: #f8f9fa;
          border: 1px solid #e6ebf1;
          border-radius: 6px;
          padding: 20px;
          margin-top: 20px;
        }
        
        .detail-row {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
          font-size: 14px;
        }
        
        .detail-label {
          color: #8898aa;
          display: flex;
          align-items: center;
          gap: 8px;
        }
        
        .detail-value {
          color: #32325d;
          font-weight: 500;
        }
        
        .total-row {
          border-top: 1px solid #e6ebf1;
          padding-top: 12px;
          margin-top: 12px;
          font-weight: 600;
          font-size: 16px;
        }
        
        .product-info {
          display: flex;
          align-items: flex-start;
          gap: 12px;
          margin-bottom: 20px;
          padding-bottom: 16px;
          border-bottom: 1px solid #e6ebf1;
        }
        
        .product-image {
          width: 48px;
          height: 48px;
          background: #f6f9fc;
          border-radius: 6px;
          overflow: hidden;
          flex-shrink: 0;
        }
        
        .product-image img {
          width: 100%;
          height: 100%;
          object-fit: cover;
        }
        
        .product-text {
          flex: 1;
          min-width: 0;
        }
        
        .product-title {
          font-size: 14px;
          font-weight: 500;
          color: #32325d;
          margin-bottom: 4px;
          word-wrap: break-word;
        }
        
        .product-variants {
          font-size: 12px;
          color: #8898aa;
          margin-bottom: 4px;
        }
        
        .product-quantity {
          font-size: 12px;
          color: #8898aa;
        }
        
        .product-price {
          font-size: 14px;
          font-weight: 500;
          color: #32325d;
          flex-shrink: 0;
        }
        
        .original-price {
          font-size: 12px;
          color: #8898aa;
          margin-top: 12px;
          text-align: right;
        }
        
        .free-badge {
          color: #00d924;
          font-weight: 500;
        }
      `}</style>
      
      <div className="product-details">
        {/* Product Info */}
        <div className="product-info">
          {/* Product Image */}
          {product.images && product.images.length > 0 && (
            <div className="product-image">
              <img
                src={formatImageUrl(product.images[0].url)}
                alt={product.title}
              />
            </div>
          )}
          
          {/* Product Details */}
          <div className="product-text">
            <div className="product-title">{product.title}</div>
            
            {/* Selected variants */}
            {variantSelections.length > 0 && variantSelections.every(v => v.value) && (
              <div className="product-variants">
                {variantSelections.map((selection, index) => (
                  <div key={index}>
                    {selection.name}: {selection.value}
                  </div>
                ))}
              </div>
            )}
            
            <div className="product-quantity">Qty: {quantity}</div>
          </div>
          
          {/* Price */}
          <div className="product-price">
            {formatPrice(displayPrice * quantity, displayCurrency)}
          </div>
        </div>
        
        {/* Price Breakdown */}
        <div className="detail-row">
          <span className="detail-label">Subtotal</span>
          <span className="detail-value">{formatPrice(subtotal, displayCurrency)}</span>
        </div>
        
        {vat > 0 && (
          <div className="detail-row">
            <span className="detail-label">VAT</span>
            <span className="detail-value">{formatPrice(vat, displayCurrency)}</span>
          </div>
        )}
        
        {shipping > 0 && (
          <div className="detail-row">
            <span className="detail-label">Shipping</span>
            <span className="detail-value">{formatPrice(shipping, displayCurrency)}</span>
          </div>
        )}
        
        {shipping === 0 && selectedShipping && (
          <div className="detail-row">
            <span className="detail-label">Shipping</span>
            <span className="detail-value free-badge">Free</span>
          </div>
        )}
        
        {/* Total */}
        <div className="detail-row total-row">
          <span className="detail-label">Total</span>
          <span className="detail-value">
            {formatPrice(total, displayCurrency)}
          </span>
        </div>
        
        {/* Show original price if converted */}
        {displayCurrency !== product.defaultCurrency && (
          <div className="original-price">
            Original: {formatPrice(product.price * quantity, product.defaultCurrency)}
          </div>
        )}
      </div>
    </>
  );
};

export default CheckoutSummary;

PaymentForm.tsx
// productcomponents/PaymentForm.tsx
'use client';
import { useState, useEffect, FormEvent } from 'react';
import { loadStripe, Stripe, StripeElements, StripeCardNumberElement } from '@stripe/stripe-js';
import {
  Elements,
  useStripe,
  useElements,
  CardNumberElement,
  CardExpiryElement,
  CardCvcElement,
} from '@stripe/react-stripe-js';
import { ICountry, IState } from 'country-state-city';
import { Country, State } from 'country-state-city';

import { IBillingInfo } from '../productlib/types';
import { isPixSupported, getUserCountry } from '../productlib/currency';
import { validateBillingInfo } from '../productlib/utils';
import logger from '../productlib/logger';

interface PaymentFormProps {
  currency: string;
  amount: number; // Expected in smallest currency unit (e.g., cents)
  transactionId: string;
  onSubmit: (
    billingInfo: IBillingInfo,
    paymentMethod: 'card' | 'pix' | 'paypal' | 'wallet' | 'other',
    status: 'pending' | 'successful' | 'canceled',
    paymentIntentId?: string
  ) => void;
  isSubmitting: boolean;
  // Add product details needed for create-intent
  productOwnerId: string;
  productId: string;
  productName: string;
  quantity: number;
}

// Interface for CheckoutForm props
interface CheckoutFormPropsInternal {
  currency: string;
  amount: number;
  transactionId: string;
  onSubmit: PaymentFormProps['onSubmit'];
  isSubmitting: boolean;
  billingInfo: IBillingInfo;
  setBillingInfo: (info: IBillingInfo | ((prev: IBillingInfo) => IBillingInfo)) => void;
  errors: Record<string, string>;
  setErrors: (errors: Record<string, string> | ((prev: Record<string, string>) => Record<string, string>)) => void;
  productOwnerId: string;
  productId: string;
  productName: string;
  quantityParam: number;
}

let stripePromiseSingleton: Promise<Stripe | null> | null = null;

const getStripeInstance = (): Promise<Stripe | null> => {
  if (!stripePromiseSingleton) {
    stripePromiseSingleton = (async () => {
      try {
        const baseUrl = process.env.NEXT_PUBLIC_API_BASE_URL ||
                        (process.env.NODE_ENV === 'development' ? 'http://localhost:5000' : window.location.origin);
        
        const apiUrl = `${baseUrl.replace(/\/api$/, '')}/api/payments/config`;
        logger.info('[PaymentForm] Fetching payment config from:', apiUrl);
        const response = await fetch(apiUrl);

        if (!response.ok) {
            const errorText = await response.text();
            logger.error('[PaymentForm] Failed to fetch payment config. Status:', response.status, 'Response:', errorText);
            return null;
        }
        const config = await response.json();
        logger.info('[PaymentForm] Payment config response:', config);
        
        if (config.success && config.data?.processors?.stripe?.configured && config.data.processors.stripe.publicKey) {
          logger.info('[PaymentForm] Stripe loaded successfully with key prefix:', config.data.processors.stripe.publicKey.substring(0, 20) + '...');
          return loadStripe(config.data.processors.stripe.publicKey);
        } else {
          logger.error('[PaymentForm] Stripe not configured or public key missing in fetched config:', config.data?.processors?.stripe);
          return null;
        }
      } catch (error) {
        logger.error('[PaymentForm] Error loading Stripe config or initializing Stripe.js:', error);
        return null;
      }
    })();
  }
  return stripePromiseSingleton;
};

const CARD_ELEMENT_OPTIONS = {
  style: {
    base: {
      color: '#32325d',
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", sans-serif',
      fontSmoothing: 'antialiased',
      fontSize: '16px',
      '::placeholder': {
        color: '#aab7c4',
      },
    },
    invalid: {
      color: '#fa755a',
      iconColor: '#fa755a',
    },
  },
  showIcon: false,
};

const CheckoutForm: React.FC<CheckoutFormPropsInternal> = ({
  currency,
  amount,
  transactionId,
  onSubmit,
  isSubmitting,
  billingInfo,
  setBillingInfo,
  errors,
  setErrors,
  productOwnerId,
  productId,
  productName,
  quantityParam,
}) => {
  const stripe = useStripe();
  const elements = useElements();
  const [paymentError, setPaymentError] = useState<string>('');
  const [processing, setProcessing] = useState(false);
  const [countries, setCountries] = useState<ICountry[]>([]);
  const [states, setStates] = useState<IState[]>([]);
  const [selectedCountry, setSelectedCountry] = useState<string>(billingInfo.country || '');
  const [clientSecret, setClientSecret] = useState<string>('');
  const [paymentIntentCreated, setPaymentIntentCreated] = useState(false);
  const [selectedPaymentMethod, setSelectedPaymentMethod] = useState<'card' | 'pix'>('card');
  const [addressLine2, setAddressLine2] = useState<string>('');

  const pixSupported = isPixSupported(currency);

  useEffect(() => {
    setCountries(Country.getAllCountries());
  }, []);

  useEffect(() => {
    if (selectedCountry) {
      setStates(State.getStatesOfCountry(selectedCountry));
      if (billingInfo.country !== selectedCountry) {
        setBillingInfo(prev => ({ ...prev, country: selectedCountry, state: '' }));
      }
    } else {
      setStates([]);
    }
  }, [selectedCountry]);

  useEffect(() => {
    if (billingInfo.country && billingInfo.country !== selectedCountry) {
      setSelectedCountry(billingInfo.country);
    }
  }, [billingInfo.country, selectedCountry]);

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setBillingInfo(prev => ({ ...prev, [name]: value }));
    if (errors[name]) {
      setErrors(prev => { const newErrors = { ...prev }; delete newErrors[name]; return newErrors; });
    }
  };

  const handleCountryChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    setSelectedCountry(e.target.value);
  };

  const createPaymentIntent = async (): Promise<string | null> => {
    if (paymentIntentCreated || clientSecret) {
      return clientSecret;
    }

    try {
      const baseUrl = process.env.NEXT_PUBLIC_API_BASE_URL ||
                      (process.env.NODE_ENV === 'development' ? 'http://localhost:5000' : window.location.origin);
      
      const apiUrl = `${baseUrl.replace(/\/api$/, '')}/api/payments/create-intent`;
      
      logger.info('[PaymentForm] Creating payment intent for transaction:', transactionId);
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amount, // This is already smallest unit (e.g. cents)
          currency: currency.toLowerCase(), // This is the currency code like 'brl'
          transactionId, // The TX_... ID
          description: `Purchase: ${productName} (x${quantityParam}) - TX: ${transactionId}`,
          // Pass new data
          productOwnerId: productOwnerId,
          productId: productId,
          productName: productName,
          quantity: quantityParam,
          customerEmail: billingInfo.email, // Pass customer email if available
        }),
      });
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({message: "Failed to parse error from create-intent"}));
        logger.error('[PaymentForm] Failed to create payment intent. Status:', response.status, 'Error:', errorData);
        throw new Error(errorData.message || `Failed to initialize payment (HTTP ${response.status})`);
      }

      const data = await response.json();
      if (data.success && data.data.clientSecret) {
        logger.info('[PaymentForm] Payment intent created successfully. Client Secret (first 20):', data.data.clientSecret.substring(0,20)+'...');
        setClientSecret(data.data.clientSecret);
        setPaymentIntentCreated(true);
        return data.data.clientSecret;
      } else {
        logger.error('[PaymentForm] Failed to get clientSecret from create-intent:', data.message || 'Unknown error', data.errors);
        throw new Error(data.message || 'Failed to initialize payment details.');
      }
    } catch (error) {
      logger.error('[PaymentForm] Error creating payment intent:', error);
      throw error;
    }
  };

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    setPaymentError('');
    
    // Merge address line 1 and 2
    const mergedAddress = addressLine2 
      ? `${billingInfo.address}, ${addressLine2}`
      : billingInfo.address;
    
    const finalBillingInfo = {
      ...billingInfo,
      address: mergedAddress
    };
    
    if (selectedPaymentMethod === 'pix') {
      // Handle PIX payment
      const validation = validateBillingInfo(finalBillingInfo);
      if (!validation.valid) {
        setErrors(validation.errors);
        return;
      }
      
      onSubmit(finalBillingInfo, 'pix', 'pending');
      return;
    }

    if (!stripe || !elements) {
      setPaymentError('Stripe has not loaded yet. Please try again.');
      logger.warn('[CheckoutForm] handleSubmit: Stripe or Elements not ready.');
      return;
    }

    const cardNumberElement = elements.getElement(CardNumberElement);
    if (!cardNumberElement) {
      setPaymentError('Card number element not ready.');
      logger.warn('[CheckoutForm] handleSubmit: CardNumberElement not found.');
      return;
    }
    
    if (processing || isSubmitting) return;
    setProcessing(true);

    try {
      const validation = validateBillingInfo(finalBillingInfo);
      if (!validation.valid) {
        setErrors(validation.errors);
        setProcessing(false);
        logger.info('[CheckoutForm] Billing info validation failed:', validation.errors);
        return;
      }

      let currentClientSecret = clientSecret;
      if (!currentClientSecret) {
        currentClientSecret = await createPaymentIntent();
        if (!currentClientSecret) {
          setPaymentError('Failed to initialize payment. Please try again.');
          setProcessing(false);
          return;
        }
      }
      
      logger.info('[CheckoutForm] Attempting to create PaymentMethod...');
      const { error: createPmError, paymentMethod } = await stripe.createPaymentMethod({
        type: 'card',
        card: cardNumberElement,
        billing_details: {
          name: finalBillingInfo.name,
          email: finalBillingInfo.email,
          phone: finalBillingInfo.phone,
          address: {
            line1: finalBillingInfo.address,
            city: finalBillingInfo.city,
            state: finalBillingInfo.state,
            postal_code: finalBillingInfo.postalCode,
            country: finalBillingInfo.country,
          },
        },
      });

      if (createPmError) {
        logger.error('[CheckoutForm] createPaymentMethod failed:', createPmError);
        setPaymentError(createPmError.message || 'Failed to process payment details.');
        onSubmit(finalBillingInfo, 'card', 'canceled');
        setProcessing(false);
        return;
      }
      logger.info('[CheckoutForm] PaymentMethod created:', paymentMethod.id);

      logger.info('[CheckoutForm] Confirming card payment with clientSecret (first 20 chars):', currentClientSecret.substring(0,20)+'...');
      const { error: confirmError, paymentIntent } = await stripe.confirmCardPayment(currentClientSecret, {
        payment_method: paymentMethod.id,
      });

      if (confirmError) {
        logger.error('[CheckoutForm] Payment confirmation failed:', confirmError);
        setPaymentError(confirmError.message || 'Payment failed. Please try again.');
        onSubmit(finalBillingInfo, 'card', 'canceled', paymentIntent ? paymentIntent.id : undefined);
      } else if (paymentIntent) {
        logger.info('[CheckoutForm] Payment intent after confirmation:', paymentIntent.id, 'Status:', paymentIntent.status);
        let status: 'pending' | 'successful' | 'canceled' = 'pending';
        if (paymentIntent.status === 'succeeded') status = 'successful';
        else if (paymentIntent.status === 'canceled') status = 'canceled';
        else if (['requires_action', 'requires_confirmation', 'processing'].includes(paymentIntent.status)) status = 'pending';
        
        onSubmit(finalBillingInfo, 'card', status, paymentIntent.id);
      }
    } catch (err: any) {
      logger.error('[CheckoutForm] Unexpected error during payment submission:', err);
      setPaymentError('An unexpected error occurred. Please try again.');
      
      const mergedAddress = addressLine2 
        ? `${billingInfo.address}, ${addressLine2}`
        : billingInfo.address;
      
      const finalBillingInfo = {
        ...billingInfo,
        address: mergedAddress
      };
      
      onSubmit(finalBillingInfo, 'card', 'canceled');
    } finally {
      setProcessing(false);
    }
  };

  const getDisplayAmount = () => {
    return new Intl.NumberFormat(undefined, { 
      style: 'currency', 
      currency: currency.toUpperCase() 
    }).format(amount / 100);
  };

  return (
    <>
      <style jsx>{`
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        
        .form-group {
          margin-bottom: 24px;
        }
        
        .form-label {
          display: block;
          font-size: 13px;
          font-weight: 500;
          color: #6b7c93;
          margin-bottom: 8px;
        }
        
        .section-title {
          font-size: 16px;
          font-weight: 500;
          color: #32325d;
          margin-bottom: 16px;
        }
        
        .form-input {
          width: 100%;
          padding: 12px;
          border: 1px solid #cfd7df;
          border-radius: 4px;
          font-size: 16px;
          color: #32325d;
          background: white;
          transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }
        
        .form-input:focus {
          outline: none;
          border-color: #635bff;
          box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.2);
        }
        
        .form-input::placeholder {
          color: #aab7c4;
        }
        
        .billing-group {
          border: 1px solid #cfd7df;
          border-radius: 4px;
          overflow: hidden;
          background: white;
        }
        
        .billing-group .form-input {
          border: none;
          border-radius: 0;
          width: 100%;
        }
        
        .billing-group .form-input:focus {
          box-shadow: none;
          border-color: transparent;
        }
        
        .billing-group > *:not(:last-child) {
          border-bottom: 1px solid #e6ebf1;
        }
        
        .billing-row {
          display: flex;
        }
        
        .billing-row .form-input {
          border-bottom: none;
        }
        
        .billing-row .form-input:first-child {
          border-right: 1px solid #e6ebf1;
        }
        
        .phone-input {
          position: relative;
        }
        
        .flag-icon {
          position: absolute;
          left: 12px;
          top: 50%;
          transform: translateY(-50%);
          width: 20px;
          height: 15px;
          z-index: 2;
          object-fit: cover;
          border-radius: 2px;
        }
        
        .phone-input .form-input {
          padding-left: 36px;
          padding-right: 40px;
          border: none;
        }
        
        .info-icon {
          position: absolute;
          right: 12px;
          top: 50%;
          transform: translateY(-50%);
          color: #8898aa;
          font-size: 12px;
          cursor: help;
        }
        
        .payment-methods {
          margin: 20px 0;
        }
        
        .payment-method {
          border: 1px solid #e6ebf1;
          border-radius: 6px;
          margin-bottom: 12px;
          overflow: hidden;
          transition: border-color 0.15s, box-shadow 0.15s;
        }
        
        .payment-method:hover {
          border-color: #cfd7df;
        }
        
        .payment-method.selected {
          border-color: #000;
        }
        
        .payment-method-header {
          padding: 16px;
          display: flex;
          align-items: center;
          gap: 12px;
          cursor: pointer;
          background: #fff;
          transition: background-color 0.15s;
          border: none;
          width: 100%;
          text-align: left;
        }
        
        .payment-method-header:hover {
          background: #f8f9fa;
        }
        
        .payment-radio {
          width: 18px;
          height: 18px;
          border: 2px solid #cfd7df;
          border-radius: 50%;
          position: relative;
          flex-shrink: 0;
        }
        
        .payment-radio.checked {
          border-color: #000;
        }
        
        .payment-radio.checked::after {
          content: '';
          width: 8px;
          height: 8px;
          background: #000;
          border-radius: 50%;
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
        }
        
        .payment-method-info {
          flex: 1;
          display: flex;
          align-items: center;
          gap: 12px;
        }
        
        .payment-method-icon {
          width: 32px;
          height: 20px;
          background: #f7f9fa;
          border: 1px solid #e6ebf1;
          border-radius: 4px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 12px;
          color: #32325d;
          font-weight: 600;
        }
        
        .payment-method-name {
          font-size: 16px;
          font-weight: 500;
          color: #32325d;
        }
        
        .payment-icons {
          display: flex;
          gap: 6px;
        }
        
        .card-brand-icon {
          width: 24px;
          height: 16px;
        }
        
        .payment-details {
          padding: 0 16px 16px;
          border-top: 1px solid #e6ebf1;
          display: none;
        }
        
        .payment-method.selected .payment-details {
          display: block;
        }
        
        .card-group {
          border: 1px solid #cfd7df;
          border-radius: 4px;
          overflow: hidden;
          background: white;
        }
        
        .card-number-input {
          position: relative;
          padding: 12px;
          border-bottom: 1px solid #e6ebf1;
        }
        
        .card-row {
          display: flex;
        }
        
        .card-expiry {
          flex: 1;
          position: relative;
          padding: 12px;
          border-right: 1px solid #e6ebf1;
        }
        
        .card-cvc {
          flex: 1;
          position: relative;
          padding: 12px;
        }
        
        .cvc-icon {
          position: absolute;
          right: 12px;
          top: 50%;
          transform: translateY(-50%);
          color: #8898aa;
          font-size: 14px;
        }
        
        .billing-checkbox {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-top: 16px;
          font-size: 14px;
          color: #6b7c93;
        }
        
        .billing-checkbox input[type="checkbox"] {
          width: 16px;
          height: 16px;
          accent-color: #000;
        }
        
        .checkbox-group {
          display: flex;
          align-items: flex-start;
          gap: 12px;
          padding: 16px;
          border: 1px solid #e6ebf1;
          border-radius: 4px;
          background: #f7f9fc;
          margin-bottom: 24px;
        }
        
        .checkbox {
          margin-top: 2px;
          width: 16px;
          height: 16px;
          accent-color: #000;
        }
        
        .checkbox-label {
          font-size: 13px;
          color: #32325d;
          line-height: 1.4;
        }
        
        .checkbox-sublabel {
          font-size: 13px;
          color: #8898aa;
          margin-top: 4px;
        }
        
        .pay-button {
          width: 100%;
          padding: 14px;
          background: #0073E6;
          color: white;
          border: none;
          border-radius: 6px;
          font-size: 16px;
          font-weight: 500;
          cursor: pointer;
          transition: background-color 0.15s ease;
          margin-bottom: 16px;
        }
        
        .pay-button:hover:not(:disabled) {
          background: #0066CC;
        }
        
        .pay-button:disabled {
          background: #8898aa;
          cursor: not-allowed;
        }
        
        .footer {
          text-align: center;
          margin-top: 24px;
        }
        
        .footer-text {
          font-size: 12px;
          color: #8898aa;
          margin-bottom: 8px;
        }
        
        .footer-links {
          display: flex;
          justify-content: center;
          gap: 16px;
        }
        
        .footer-link {
          font-size: 12px;
          color: #8898aa;
          text-decoration: none;
        }
        
        .footer-link:hover {
          text-decoration: underline;
        }
        
        .or-divider {
          text-align: center;
          margin: 20px 0;
          position: relative;
          color: #8898aa;
          font-size: 14px;
        }
        
        .or-divider::before {
          content: '';
          position: absolute;
          top: 50%;
          left: 0;
          right: 0;
          height: 1px;
          background: #e6ebf1;
        }
        
        .or-divider span {
          background: #fff;
          padding: 0 16px;
          position: relative;
        }
        
        .error-display {
          background: #fdf2f2;
          border: 1px solid #fecaca;
          border-radius: 6px;
          padding: 12px;
          margin-bottom: 16px;
          color: #dc2626;
          font-size: 14px;
          text-align: center;
        }
        
        .hidden-methods {
          display: none;
        }
      `}</style>

      <form onSubmit={handleSubmit}>
        {/* Pay with Link Button - Hidden for now */}
        <div className="hidden-methods">
          <div className="form-group">
            <button type="button" style={{
              width: '100%',
              padding: '14px',
              background: '#00D924',
              color: 'white',
              border: 'none',
              borderRadius: '6px',
              fontSize: '16px',
              fontWeight: '600',
              cursor: 'pointer',
              marginBottom: '16px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: '8px'
            }}>
              Pay with <strong>link</strong>
            </button>
            <div className="or-divider">
              <span>Or</span>
            </div>
          </div>
        </div>

        {/* Shipping Information */}
        <div className="form-group">
          <div className="section-title">Shipping information</div>
          
          <div className="form-group">
            <label className="form-label">Email</label>
            <input 
              type="email" 
              name="email"
              className="form-input" 
              placeholder="email@example.com" 
              value={billingInfo.email}
              onChange={handleInputChange}
              required 
              disabled={isSubmitting || processing}
            />
            {errors.email && <div style={{color: '#dc2626', fontSize: '12px', marginTop: '4px'}}>{errors.email}</div>}
          </div>

          <div className="form-group">
            <label className="form-label">Shipping address</label>
            <div className="billing-group">
              <input 
                type="text" 
                name="name"
                className="form-input" 
                placeholder="Full name" 
                value={billingInfo.name}
                onChange={handleInputChange}
                required 
                disabled={isSubmitting || processing}
              />
              {errors.name && <p className="mt-1 text-xs text-red-600">{errors.name}</p>}
              
              <select 
                name="country"
                className="form-input" 
                value={selectedCountry}
                onChange={handleCountryChange}
                required
                disabled={isSubmitting || processing}
              >
                <option value="">Select Country</option>
                {countries.map((country) => (
                  <option key={country.isoCode} value={country.isoCode}>
                    {country.name}
                  </option>
                ))}
              </select>
              {errors.country && <p className="mt-1 text-xs text-red-600">{errors.country}</p>}
              
              <input 
                type="text" 
                name="address"
                className="form-input" 
                placeholder="Address line 1" 
                value={billingInfo.address}
                onChange={handleInputChange}
                required 
                disabled={isSubmitting || processing}
              />
              {errors.address && <p className="mt-1 text-xs text-red-600">{errors.address}</p>}
              
              <input 
                type="text" 
                className="form-input" 
                placeholder="Address line 2" 
                value={addressLine2}
                onChange={(e) => setAddressLine2(e.target.value)}
                disabled={isSubmitting || processing}
              />
              
              <div className="billing-row">
                <input 
                  type="text" 
                  name="city"
                  className="form-input" 
                  placeholder="City" 
                  value={billingInfo.city}
                  onChange={handleInputChange}
                  required 
                  disabled={isSubmitting || processing}
                />
                {errors.city && <p className="mt-1 text-xs text-red-600">{errors.city}</p>}
                <input 
                  type="text" 
                  name="postalCode"
                  className="form-input" 
                  placeholder="ZIP" 
                  value={billingInfo.postalCode}
                  onChange={handleInputChange}
                  required 
                  disabled={isSubmitting || processing}
                />
                {errors.postalCode && <p className="mt-1 text-xs text-red-600">{errors.postalCode}</p>}
              </div>
              
              {states.length > 0 ? (
                <select 
                  name="state"
                  className="form-input" 
                  value={billingInfo.state}
                  onChange={handleInputChange}
                  required
                  disabled={isSubmitting || processing || states.length === 0}
                >
                  <option value="">Select State</option>
                  {states.map((state) => (
                    <option key={state.isoCode} value={state.isoCode}>
                      {state.name}
                    </option>
                  ))}
                </select>
              ) : selectedCountry ? (
                <input 
                  type="text" 
                  name="state"
                  className="form-input" 
                  placeholder="State / Province (if applicable)" 
                  value={billingInfo.state}
                  onChange={handleInputChange}
                  disabled={isSubmitting || processing}
                />
              ) : null}
              {errors.state && <p className="mt-1 text-xs text-red-600">{errors.state}</p>}
              
              <div className="phone-input">
                <img 
                  src={`https://flagcdn.com/w20/${selectedCountry.toLowerCase()}.png`} 
                  alt={selectedCountry} 
                  className="flag-icon"
                  onError={(e) => {
                    (e.target as HTMLImageElement).src = "https://flagcdn.com/w20/us.png";
                  }}
                />
                <input 
                  type="tel" 
                  name="phone"
                  className="form-input" 
                  placeholder="Phone number (optional)" 
                  value={billingInfo.phone || ''}
                  onChange={handleInputChange}
                  disabled={isSubmitting || processing}
                />
                <i className="fas fa-info-circle info-icon"></i>
              </div>
              {errors.phone && <p className="mt-1 text-xs text-red-600">{errors.phone}</p>}
            </div>
          </div>
        </div>

        {/* Payment Methods */}
        <div className="form-group">
          <div className="section-title">Payment method</div>
          
          <div className="payment-methods">
            {/* Card Payment */}
            <div className={`payment-method ${selectedPaymentMethod === 'card' ? 'selected' : ''}`}>
              <button 
                type="button" 
                className="payment-method-header" 
                onClick={() => setSelectedPaymentMethod('card')}
              >
                <div className={`payment-radio ${selectedPaymentMethod === 'card' ? 'checked' : ''}`}></div>
                <div className="payment-method-info">
                  <div className="payment-method-icon">
                    <i className="fas fa-credit-card"></i>
                  </div>
                  <span className="payment-method-name">Card</span>
                </div>
                <div className="payment-icons">
                  <img src="https://js.stripe.com/v3/fingerprinted/img/visa-365725566f9578a9589553aa9296d178.svg" alt="Visa" className="card-brand-icon" />
                  <img src="https://js.stripe.com/v3/fingerprinted/img/mastercard-4d8844094130711885b5e41b28c9848f.svg" alt="Mastercard" className="card-brand-icon" />
                  <img src="https://js.stripe.com/v3/fingerprinted/img/amex-a49b82f46c5cd6a96a6e418a6ca1717c.svg" alt="American Express" className="card-brand-icon" />
                  <img src="https://js.stripe.com/v3/fingerprinted/img/jcb-271fd06e6e0a5af2601265d1107d8c96.svg" alt="JCB" className="card-brand-icon" />
                </div>
              </button>
              
              <div className="payment-details">
                <div className="form-group">
                  <label className="form-label">Card information</label>
                  <div className="card-group">
                    <div className="card-number-input">
                      <CardNumberElement options={CARD_ELEMENT_OPTIONS} />
                    </div>
                    
                    <div className="card-row">
                      <div className="card-expiry">
                        <CardExpiryElement options={CARD_ELEMENT_OPTIONS} />
                      </div>
                      <div className="card-cvc">
                        <CardCvcElement options={CARD_ELEMENT_OPTIONS} />
                        <i className="fas fa-credit-card cvc-icon"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* PIX Payment - Only show for BRL */}
            {pixSupported && (
              <div className={`payment-method ${selectedPaymentMethod === 'pix' ? 'selected' : ''}`}>
                <button 
                  type="button" 
                  className="payment-method-header" 
                  onClick={() => setSelectedPaymentMethod('pix')}
                >
                  <div className={`payment-radio ${selectedPaymentMethod === 'pix' ? 'checked' : ''}`}></div>
                  <div className="payment-method-info">
                    <div className="payment-method-icon" style={{background: '#32BCAD', color: '#fff'}}>
                      PIX
                    </div>
                    <span className="payment-method-name">PIX</span>
                  </div>
                </button>
                <div className="payment-details">
                  <div style={{padding: '16px 0', fontSize: '14px', color: '#6b7c93'}}>
                    You will receive PIX payment instructions after clicking "Pay".
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>

        {/* Save Information Checkbox */}
        <div className="checkbox-group">
          <input type="checkbox" id="save-info" className="checkbox" />
          <label htmlFor="save-info">
            <div className="checkbox-label">Securely save my information for 1-click checkout</div>
            <div className="checkbox-sublabel">Pay faster on our store and everywhere Link is accepted.</div>
          </label>
        </div>

        {/* Error Display */}
        {paymentError && (
          <div className="error-display">
            {paymentError}
          </div>
        )}

        {/* Pay Button */}
        <button 
          type="submit" 
          className="pay-button"
          disabled={isSubmitting || processing || (selectedPaymentMethod === 'card' && (!stripe || !elements))}
        >
          {isSubmitting || processing ? (
            <div style={{display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px'}}>
              <div style={{
                width: '16px',
                height: '16px',
                border: '2px solid white',
                borderTop: '2px solid transparent',
                borderRadius: '50%',
                animation: 'spin 1s linear infinite'
              }}></div>
              <span>Processing...</span>
            </div>
          ) : (
            `Pay ${getDisplayAmount()}`
          )}
        </button>
        
        {selectedPaymentMethod === 'card' && (
          <div style={{textAlign: 'center', marginTop: '16px', fontSize: '13px', color: '#8898aa'}}>
            Your payment information is secure and encrypted.
          </div>
        )}
      </form>

      {/* Footer */}
      <div className="footer">
        <div className="footer-text">
          Powered by <strong>stripe</strong>
        </div>
        <div className="footer-links">
          <a href="#" className="footer-link">Terms</a>
          <a href="#" className="footer-link">Privacy</a>
        </div>
      </div>
    </>
  );
};

const PaymentForm: React.FC<PaymentFormProps> = ({ 
  currency, 
  amount,
  transactionId,
  onSubmit,
  isSubmitting,
  productOwnerId,
  productId,
  productName,
  quantity
}) => {
  const [billingInfo, setBillingInfo] = useState<IBillingInfo>({
    email: '', phone: '', name: '', address: '', city: '', state: '', postalCode: '', country: '',
  });
  const [errors, setErrors] = useState<Record<string, string>>({});
  const [stripeApiPromise, setStripeApiPromise] = useState<Promise<Stripe | null> | null>(null);
  const [stripeError, setStripeError] = useState<string>('');

  const pixSupported = isPixSupported(currency);

  useEffect(() => {
    const detectCountry = async () => {
      try {
        const countryIsoCode = await getUserCountry();
        logger.info("[PaymentForm] Detected user country:", countryIsoCode);
        setBillingInfo(prev => ({ ...prev, country: countryIsoCode }));
      } catch (error) {
        logger.error('[PaymentForm] Error detecting country:', error);
        setBillingInfo(prev => ({ ...prev, country: 'US' }));
      }
    };
    detectCountry();
  }, []);

  useEffect(() => {
    logger.info('[PaymentForm] Initializing Stripe.js promise.');
    setStripeApiPromise(getStripeInstance());
  }, []);

  if (stripeError) {
    return (
      <div style={{
        background: 'white',
        borderRadius: '6px',
        border: '1px solid #fecaca',
        padding: '20px',
        textAlign: 'center'
      }}>
        <div style={{
          width: '48px',
          height: '48px',
          background: '#fef2f2',
          borderRadius: '50%',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          margin: '0 auto 16px',
          color: '#dc2626'
        }}>
          <i className="fas fa-exclamation-triangle"></i>
        </div>
        <h3 style={{fontSize: '16px', fontWeight: '500', color: '#32325d', marginBottom: '8px'}}>
          Payment Unavailable
        </h3>
        <p style={{color: '#6b7c93', marginBottom: '16px', fontSize: '14px'}}>{stripeError}</p>
        <button 
          onClick={() => window.location.reload()} 
          style={{
            padding: '8px 16px',
            background: '#0073E6',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            fontSize: '14px',
            cursor: 'pointer'
          }}
        >
          Try Again
        </button>
      </div>
    );
  }

  if (!stripeApiPromise) {
    return (
      <div style={{
        background: 'white',
        borderRadius: '6px',
        padding: '40px',
        textAlign: 'center'
      }}>
        <div style={{
          width: '32px',
          height: '32px',
          border: '3px solid #635bff',
          borderTop: '3px solid transparent',
          borderRadius: '50%',
          animation: 'spin 1s linear infinite',
          margin: '0 auto 20px'
        }}></div>
        <p style={{color: '#6b7c93', fontSize: '14px'}}>Loading payment form...</p>
      </div>
    );
  }

  return (
    <Elements stripe={stripeApiPromise}>
      <CheckoutForm
        currency={currency}
        amount={amount}
        transactionId={transactionId}
        onSubmit={onSubmit}
        isSubmitting={isSubmitting}
        billingInfo={billingInfo}
        setBillingInfo={setBillingInfo}
        errors={errors}
        setErrors={setErrors}
        productOwnerId={productOwnerId}
        productId={productId}
        productName={productName}
        quantityParam={quantity}
      />
    </Elements>
  );
};

export default PaymentForm;

ProductDisplay.tsx
// productcomponents/ProductDisplay.tsx
'use client';

import { useState, useEffect, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { IProduct, IVariantSelection, IBillingInfo, ITransactionItem } from '../productlib/types';
import { formatPrice, getUserCurrency, convertPrice, isPixSupported } from '../productlib/currency';
import { isProductInStock, calculateTotalPrice, generateTransactionId as generateFrontendTxId } from '../productlib/utils';
import { createTransaction, getIPAddress, getDeviceInfo } from '../productlib/api';
import PaymentForm from './PaymentForm';

interface ProductWithLocalCurrency extends IProduct {
  localPrice?: number;
  localCurrency?: string;
}

interface ProductDisplayProps {
  product: IProduct;
}

const ProductDisplay: React.FC<ProductDisplayProps> = ({ product: initialProduct }) => {
  const router = useRouter();
  const [product, setProduct] = useState<ProductWithLocalCurrency>(initialProduct);
  const [isLoading, setIsLoading] = useState(true);
  const [localCurrency, setLocalCurrency] = useState<string>('');
  const [quantity, setQuantity] = useState(1);
  const [variantSelections, setVariantSelections] = useState<IVariantSelection[]>([]);
  const [selectedShipping, setSelectedShipping] = useState<string>('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [errorMessage, setErrorMessage] = useState<string>('');
  const [transactionId, setTransactionId] = useState<string>('');
  const [showProductDetails, setShowProductDetails] = useState(false);

  useEffect(() => {
    // Generate transaction ID early
    setTransactionId(generateFrontendTxId());
    
    const fetchUserCurrencyAndProductDetails = async () => {
      try {
        setIsLoading(true);
        const currency = await getUserCurrency();
        setLocalCurrency(currency);
        
        if (currency && currency !== initialProduct.defaultCurrency && initialProduct.autoLocalPrice) {
          try {
            const convertedPrice = await convertPrice(initialProduct.price, initialProduct.defaultCurrency, currency);
            setProduct({ ...initialProduct, localPrice: convertedPrice, localCurrency: currency });
          } catch (convError) {
            console.error('[ProductDisplay] Error converting price:', convError);
            setProduct(initialProduct);
          }
        } else {
          setProduct(initialProduct);
        }
      } catch (error) {
        console.error('[ProductDisplay] Error fetching user currency:', error);
        setLocalCurrency(initialProduct.defaultCurrency);
        setProduct(initialProduct);
      } finally {
        setIsLoading(false);
      }
    };
    
    fetchUserCurrencyAndProductDetails();

    if (initialProduct.type === 'physical' && initialProduct.physical?.shippingMethods?.length) {
      setSelectedShipping(initialProduct.physical.shippingMethods[0].name);
    }

    // Initialize variant selections
    if (initialProduct.variants && initialProduct.variants.length > 0) {
      const initialSelections = initialProduct.variants.map(variant => ({
        name: variant.name,
        value: '',
      }));
      setVariantSelections(initialSelections);
    }
  }, [initialProduct]);

  const paymentDetails = useMemo(() => {
    // Calculate total in the original product's default currency first
    const originalPrices = calculateTotalPrice(
      initialProduct, // Always use initialProduct for base calculation
      quantity,
      selectedShipping
    );

    // Determine the currency to be used for display and payment
    const displayCurrencyCode = product.localCurrency || initialProduct.defaultCurrency;
    let finalTotalMainUnit = originalPrices.total;
    let finalCurrencyCode = initialProduct.defaultCurrency;

    // Check if conversion to a local currency is applicable and desired
    if (
      displayCurrencyCode !== initialProduct.defaultCurrency &&
      product.localPrice !== undefined && // This is the converted unit price
      product.localCurrency === displayCurrencyCode && // Ensure product's localCurrency is set and matches display
      initialProduct.autoLocalPrice // Check if auto conversion is enabled
    ) {
      // Calculate conversion rate based on the single item's converted price
      const conversionRate = product.localPrice / initialProduct.price;
      
      // Apply conversion to all components of the price
      const convertedSubtotal = originalPrices.subtotal * conversionRate;
      const convertedVat = originalPrices.vat * conversionRate;
      const convertedShipping = originalPrices.shipping * conversionRate;
      
      finalTotalMainUnit = parseFloat((convertedSubtotal + convertedVat + convertedShipping).toFixed(2));
      finalCurrencyCode = displayCurrencyCode;
    } else {
      // If no conversion, use the total calculated in the product's default currency
      finalTotalMainUnit = originalPrices.total;
      finalCurrencyCode = initialProduct.defaultCurrency;
    }

    // Amount for Stripe must be in the smallest currency unit (e.g., cents, pence)
    const finalTotalSmallestUnit = Math.round(finalTotalMainUnit * 100);

    return {
      amount: finalTotalSmallestUnit,
      currency: finalCurrencyCode,
      prices: originalPrices,
      conversionRate: product.localPrice ? product.localPrice / initialProduct.price : 1,
    };
  }, [product, initialProduct, quantity, selectedShipping]);

  const canPurchase = isProductInStock(product, variantSelections);

  const handleSubmit = async (
    billingInfo: IBillingInfo,
    paymentMethod: 'card' | 'pix' | 'paypal' | 'wallet' | 'other',
    statusFromStripe: 'pending' | 'successful' | 'canceled',
    paymentIntentIdFromStripe?: string
  ) => {
    if (!transactionId) {
      console.error("[ProductDisplay] handleSubmit: transactionId is missing.");
      setErrorMessage("A transaction ID is missing. Please refresh and try again.");
      setIsSubmitting(false);
      return;
    }
    
    console.log(`[ProductDisplay] handleSubmit. PaymentProvider Status: ${statusFromStripe}, PI_ID: ${paymentIntentIdFromStripe}, App TxID: ${transactionId}, Qty: ${quantity}`);
    
    setIsSubmitting(true);
    setErrorMessage('');
      
    try {
      const { deviceInfo, browserInfo } = getDeviceInfo();
      const ipAddress = await getIPAddress();
      
      const originalPrices = calculateTotalPrice(
        initialProduct,
        quantity,
        selectedShipping
      );

      let txUnitPrice = initialProduct.price;
      let txSaleCurrency = initialProduct.defaultCurrency;
      let lineItemSubtotalWithoutVat = originalPrices.subtotal; // This is unitPrice * quantity in default currency
      let lineItemVat = originalPrices.vat; // VAT on that subtotal

      const useLocalForTx = product.localCurrency &&
        product.localCurrency !== initialProduct.defaultCurrency &&
        initialProduct.autoLocalPrice &&
        product.localPrice !== undefined;

      if (useLocalForTx && product.localPrice) {
        const conversionRate = product.localPrice / initialProduct.price;
        txUnitPrice = product.localPrice;
        txSaleCurrency = product.localCurrency!;
        lineItemSubtotalWithoutVat = parseFloat((originalPrices.subtotal * conversionRate).toFixed(2));
        lineItemVat = parseFloat((originalPrices.vat * conversionRate).toFixed(2));
      }
      
      // Grand total calculations (for the top-level transaction document)
      let txGrandSubtotal = lineItemSubtotalWithoutVat; // For a single product line, this is the same
      let txGrandVat = lineItemVat;
      let txGrandShipping = originalPrices.shipping; // Assuming shipping is for the whole order
      
      if (useLocalForTx && product.localPrice) {
         const conversionRate = product.localPrice / initialProduct.price;
         txGrandShipping = parseFloat((originalPrices.shipping * conversionRate).toFixed(2));
      }
      let txGrandTotal = parseFloat((txGrandSubtotal + txGrandVat + txGrandShipping).toFixed(2));

      // Prepare items array in the format expected by backend
      const items: ITransactionItem[] = [{ // Ensure ITransactionItem matches the modified type
        productId: initialProduct._id,
        productSlug: initialProduct.slug,
        productName: initialProduct.title,
        productType: initialProduct.type,
        productOwnerId: initialProduct.merchantId || '',
        quantity: quantity,
        unitPrice: txUnitPrice, // Unit price in the sale currency
        totalPrice: lineItemSubtotalWithoutVat, // Total for this line item (unitPrice * quantity) in sale currency
        currency: txSaleCurrency, // Currency for this line item
        vatEnabled: initialProduct.vatEnabled,
        vatAmount: lineItemVat, // VAT for this line item
        variants: variantSelections.length > 0 ? variantSelections : undefined,
      }];

      const transactionData = {
        items,
        saleCurrency: txSaleCurrency, // Overall sale currency
        total: txGrandTotal,         // Overall total for the transaction
        subtotal: txGrandSubtotal,   // Overall subtotal for the transaction
        shippingFee: txGrandShipping,  // Overall shipping
        paymentMethod,
        buyerEmail: billingInfo.email,
        buyerPhone: billingInfo.phone || '',
        billingName: billingInfo.name,
        billingAddress: billingInfo.address,
        billingCity: billingInfo.city,
        billingState: billingInfo.state,
        billingPostalCode: billingInfo.postalCode,
        billingCountry: billingInfo.country,
        ipAddress: ipAddress || '127.0.0.1',
        deviceInfo: deviceInfo || 'Unknown Device',
        browserInfo: browserInfo || 'Unknown Browser',
        status: statusFromStripe,
        
        ...(paymentMethod === 'card' && {
          useStripe: true,
          paymentIntentId: paymentIntentIdFromStripe,
        }),
        
        metadata: {
          transactionId: transactionId, // The TX_... ID
          client_quantity: quantity,
          client_selectedShipping: selectedShipping,
          client_variantSelections: variantSelections,
          client_localCurrencyAttempt: localCurrency, // The currency the user saw
          stripe_charged_amount_smallest_unit: paymentDetails.amount, // Amount sent to Stripe (cents)
          stripe_charged_currency: paymentDetails.currency, // Currency sent to Stripe
          initial_product_price: initialProduct.price,
          initial_product_currency: initialProduct.defaultCurrency,
          auto_local_price_setting: initialProduct.autoLocalPrice,
          converted_unit_local_price: product.localPrice,
          converted_local_currency: product.localCurrency,
          productSource: initialProduct.productSource || 'hosted',
        },
      };
      
      console.log('[ProductDisplay] Creating/Updating transaction with data for backend:', JSON.stringify(transactionData, null, 2));
      const response = await createTransaction(transactionData);
      
      if (response.success && response.data?.transactionId) {
        const finalStatus = response.data.transaction?.status || statusFromStripe;
        console.log(`[ProductDisplay] Backend transaction successful. TxID: ${response.data.transactionId}, Final Status: ${finalStatus}`);
        
        // Always redirect to payment status page with our transaction ID
        router.push(`/product/payment?transactionId=${transactionId}&status=${finalStatus}`);
      } else {
        console.error('[ProductDisplay] Failed to process transaction on backend:', response.message, response.errors);
        const backendErrorMsg = response.errors ? 
          (typeof response.errors === 'string' ? response.errors : JSON.stringify(response.errors)) : 
          response.message;
        throw new Error(backendErrorMsg || 'Failed to process transaction on backend.');
      }
    } catch (error) {
      console.error('[ProductDisplay] Error submitting transaction:', error);
      setErrorMessage((error as Error).message || 'An unexpected error occurred during final submission.');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleVariantChange = (variantName: string, value: string) => {
    const newSelections = variantSelections.map(selection => 
      selection.name === variantName 
        ? { ...selection, value } 
        : selection
    );
    setVariantSelections(newSelections);
  };

  const handleQuantityChange = (newQuantity: number) => {
    setQuantity(newQuantity);
  };

  const formatImageUrl = (url: string): string => {
    // If it's already a full URL, use it as-is
    if (url.startsWith('http')) {
      return url;
    }
    
    // Make sure URLs that start with /uploads have the proper /api prefix
    if (url.startsWith('/uploads') && !url.startsWith('/api/uploads')) {
      return `/api${url}`;
    }
    
    // URLs that already have /api/uploads are good
    if (url.startsWith('/api/uploads')) {
      return url;
    }
    
    // For all other cases, ensure it has the complete path
    return `/api/uploads/${url.replace(/^\//, '')}`;
  };

  const getMainImageUrl = (): string => {
    if (!product.images || product.images.length === 0) return '';
    const mainImage = product.images.find(img => img.isMain) || product.images[0];
    return mainImage ? formatImageUrl(mainImage.url) : '';
  };

  const getConvertedPrices = () => {
    const originalPrices = calculateTotalPrice(initialProduct, quantity, selectedShipping);
    
    if (product.localPrice && product.localCurrency && product.localCurrency !== initialProduct.defaultCurrency) {
      const conversionRate = product.localPrice / initialProduct.price;
      return {
        subtotal: parseFloat((originalPrices.subtotal * conversionRate).toFixed(2)),
        vat: parseFloat((originalPrices.vat * conversionRate).toFixed(2)),
        shipping: parseFloat((originalPrices.shipping * conversionRate).toFixed(2)),
        total: parseFloat(((originalPrices.subtotal + originalPrices.vat + originalPrices.shipping) * conversionRate).toFixed(2)),
        currency: product.localCurrency,
      };
    }
    
    return {
      ...originalPrices,
      currency: initialProduct.defaultCurrency,
    };
  };

  if (isLoading || !transactionId) {
    return (
      <div style={{
        minHeight: '100vh',
        backgroundColor: '#f6f9fc',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '20px',
      }}>
        <div style={{
          background: 'white',
          borderRadius: '8px',
          boxShadow: '0 4px 20px rgba(0, 0, 0, 0.1)',
          padding: '40px',
          textAlign: 'center',
          maxWidth: '400px',
          width: '100%',
        }}>
          <div style={{
            width: '32px',
            height: '32px',
            border: '3px solid #635bff',
            borderTop: '3px solid transparent',
            borderRadius: '50%',
            animation: 'spin 1s linear infinite',
            margin: '0 auto 20px',
          }} />
          <div style={{ color: '#32325d', fontSize: '16px' }}>Loading product...</div>
        </div>
      </div>
    );
  }

  const prices = getConvertedPrices();
  const displayPrice = product.localPrice ?? product.price;
  const displayCurrency = product.localCurrency || product.defaultCurrency;

  return (
    <>
      <style jsx>{`
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        
        .checkout-container {
          min-height: 100vh;
          background-color: #f6f9fc;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
          color: #32325d;
          line-height: 1.4;
        }
        
        .checkout-wrapper {
          display: flex;
          max-width: 920px;
          width: 100%;
          background: white;
          border-radius: 8px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
          overflow: hidden;
        }
        
        .product-section {
          flex: 1;
          padding: 40px;
          background: #fbfcfd;
          border-right: 1px solid #e6ebf1;
        }
        
        .payment-section {
          flex: 1;
          padding: 40px;
        }
        
        .header {
          display: flex;
          align-items: center;
          margin-bottom: 40px;
        }
        
        .business-icon {
          width: 28px;
          height: 28px;
          background: #f6f9fc;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-right: 12px;
          border: 1px solid #e6ebf1;
          color: #8898aa;
        }
        
        .business-name {
          font-size: 16px;
          font-weight: 500;
          color: #32325d;
        }
        
        .product-image {
          width: 100%;
          max-width: 200px;
          height: 150px;
          background: #f6f9fc;
          border-radius: 8px;
          margin: 0 auto 30px;
          display: flex;
          align-items: center;
          justify-content: center;
          overflow: hidden;
        }
        
        .product-image img {
          width: 100%;
          height: 100%;
          object-fit: cover;
        }
        
        .product-title {
          font-size: 18px;
          font-weight: 500;
          color: #8898aa;
          margin-bottom: 8px;
          text-align: center;
        }
        
        .product-price {
          font-size: 32px;
          font-weight: 600;
          color: #32325d;
          text-align: center;
          margin-bottom: 8px;
        }
        
        .product-description {
          font-size: 14px;
          color: #8898aa;
          text-align: center;
          margin-bottom: 20px;
        }
        
        .view-details-btn {
          background: none;
          border: none;
          color: #635bff;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          margin: 0 auto 20px;
          padding: 8px 12px;
          border-radius: 4px;
          transition: background-color 0.15s;
        }
        
        .view-details-btn:hover {
          background: #f7f9fc;
        }
        
        .view-details-icon {
          transition: transform 0.15s;
          transform: ${showProductDetails ? 'rotate(180deg)' : 'rotate(0deg)'};
        }
        
        .product-details {
          background: #f8f9fa;
          border: 1px solid #e6ebf1;
          border-radius: 6px;
          padding: 20px;
          margin-top: 20px;
          display: ${showProductDetails ? 'block' : 'none'};
        }
        
        .detail-row {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
          font-size: 14px;
        }
        
        .detail-label {
          color: #8898aa;
          display: flex;
          align-items: center;
          gap: 8px;
        }
        
        .detail-value {
          color: #32325d;
          font-weight: 500;
        }
        
        .total-row {
          border-top: 1px solid #e6ebf1;
          padding-top: 12px;
          margin-top: 12px;
          font-weight: 600;
          font-size: 16px;
        }
        
        .variant-section {
          background: #f8f9fa;
          border: 1px solid #e6ebf1;
          border-radius: 6px;
          padding: 20px;
          margin-top: 20px;
        }
        
        .variant-group {
          margin-bottom: 16px;
        }
        
        .variant-label {
          font-size: 13px;
          font-weight: 500;
          color: #6b7c93;
          margin-bottom: 8px;
          display: block;
        }
        
        .variant-select {
          width: 100%;
          padding: 12px;
          border: 1px solid #cfd7df;
          border-radius: 4px;
          font-size: 16px;
          color: #32325d;
          background: white;
          appearance: none;
          cursor: pointer;
        }
        
        .variant-select:focus {
          outline: none;
          border-color: #635bff;
          box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.2);
        }
        
        .quantity-section {
          background: #f8f9fa;
          border: 1px solid #e6ebf1;
          border-radius: 6px;
          padding: 20px;
          margin-top: 20px;
        }
        
        .quantity-controls {
          display: flex;
          align-items: center;
          gap: 12px;
        }
        
        .quantity-btn {
          width: 36px;
          height: 36px;
          border: 1px solid #cfd7df;
          border-radius: 4px;
          background: white;
          color: #32325d;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 16px;
          transition: background-color 0.15s;
        }
        
        .quantity-btn:hover:not(:disabled) {
          background: #f8f9fa;
        }
        
        .quantity-btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }
        
        .quantity-input {
          width: 60px;
          height: 36px;
          border: 1px solid #cfd7df;
          border-radius: 4px;
          text-align: center;
          font-size: 16px;
          color: #32325d;
        }
        
        .quantity-input:focus {
          outline: none;
          border-color: #635bff;
          box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.2);
        }
        
        .shipping-section {
          background: #f8f9fa;
          border: 1px solid #e6ebf1;
          border-radius: 6px;
          padding: 20px;
          margin-top: 20px;
        }
        
        .shipping-select {
          width: 100%;
          padding: 12px;
          border: 1px solid #cfd7df;
          border-radius: 4px;
          font-size: 16px;
          color: #32325d;
          background: white;
          appearance: none;
          cursor: pointer;
        }
        
        .shipping-select:focus {
          outline: none;
          border-color: #635bff;
          box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.2);
        }
        
        .error-message {
          background: #fdf2f2;
          border: 1px solid #fecaca;
          border-radius: 6px;
          padding: 16px;
          margin-top: 20px;
          color: #dc2626;
          font-size: 14px;
        }
        
        .availability-message {
          background: #fdf2f2;
          border: 1px solid #fecaca;
          border-radius: 6px;
          padding: 16px;
          margin-top: 20px;
          color: #dc2626;
          font-size: 14px;
          text-align: center;
        }
        
        @media (max-width: 768px) {
          .checkout-wrapper {
            flex-direction: column;
            max-width: 400px;
          }
          
          .product-section {
            border-right: none;
            border-bottom: 1px solid #e6ebf1;
            padding: 30px 20px;
          }
          
          .payment-section {
            padding: 30px 20px;
          }
          
          .product-image {
            max-width: 150px;
            height: 120px;
          }
          
          .product-price {
            font-size: 28px;
          }
        }
      `}</style>
      
      <div className="checkout-container">
        <div className="checkout-wrapper">
          {/* Product Section */}
          <div className="product-section">
            <div className="header">
              <div className="business-icon">
                <svg width="14" height="14" viewBox="0 0 576 512" fill="currentColor">
                  <path d="M547.6 103.8L490.3 13.1C485.2 5 476.1 0 466.4 0H109.6C99.9 0 90.8 5 85.7 13.1L28.3 103.8c-29.6 46.8-3.4 111.9 51.9 119.4c4 .5 8.1 .8 12.1 .8c26.1 0 49.3-11.4 65.2-29c15.9 17.6 39.1 29 65.2 29c26.1 0 49.3-11.4 65.2-29c15.9 17.6 39.1 29 65.2 29c26.2 0 49.3-11.4 65.2-29c16 17.6 39.1 29 65.2 29c4.1 0 8.1-.3 12.1-.8c55.5-7.4 81.8-72.5 52.1-119.4zM512 224c-17.7 0-32 14.3-32 32V448c0 17.7-14.3 32-32 32H128c-17.7 0-32-14.3-32-32V256c0-17.7-14.3-32-32-32s-32 14.3-32 32V448c0 53 43 96 96 96H448c53 0 96-43 96-96V256c0-17.7-14.3-32-32-32z"/>
                </svg>
              </div>
              <div className="business-name">Store</div>
            </div>
            
            <div className="product-image">
              {getMainImageUrl() ? (
                <img src={getMainImageUrl()} alt={product.title} />
              ) : (
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  color: '#8898aa',
                  fontSize: '14px',
                }}>
                  No image
                </div>
              )}
            </div>
            
            <div className="product-title">{product.title}</div>
            <div className="product-price">
              {formatPrice(displayPrice * quantity, displayCurrency)}
            </div>
            <div className="product-description">{product.shortDescription}</div>
            
            {/* Variants Section */}
            {product.variants && product.variants.length > 0 && (
              <div className="variant-section">
                <h4 style={{ fontSize: '14px', fontWeight: '600', color: '#32325d', marginBottom: '16px' }}>
                  Product Options
                </h4>
                {product.variants.map((variant, index) => (
                  <div key={index} className="variant-group">
                    <label className="variant-label">{variant.name}</label>
                    <select
                      className="variant-select"
                      value={variantSelections.find(s => s.name === variant.name)?.value || ''}
                      onChange={(e) => handleVariantChange(variant.name, e.target.value)}
                    >
                      <option value="">Select {variant.name}</option>
                      {variant.values.map((value, valueIndex) => (
                        <option key={valueIndex} value={value}>
                          {value}
                        </option>
                      ))}
                    </select>
                  </div>
                ))}
              </div>
            )}
            
            {/* Quantity Section */}
            <div className="quantity-section">
              <h4 style={{ fontSize: '14px', fontWeight: '600', color: '#32325d', marginBottom: '16px' }}>
                Quantity
              </h4>
              <div className="quantity-controls">
                <button
                  type="button"
                  className="quantity-btn"
                  onClick={() => handleQuantityChange(Math.max(1, quantity - 1))}
                  disabled={quantity <= 1}
                >
                  −
                </button>
                <input
                  type="number"
                  className="quantity-input"
                  min="1"
                  max={product.physical?.stock || 99}
                  value={quantity}
                  onChange={(e) => handleQuantityChange(Math.max(1, parseInt(e.target.value) || 1))}
                />
                <button
                  type="button"
                  className="quantity-btn"
                  onClick={() => handleQuantityChange(quantity + 1)}
                  disabled={product.physical?.stock ? quantity >= product.physical.stock : false}
                >
                  +
                </button>
              </div>
              {product.physical?.stock && (
                <div style={{ fontSize: '12px', color: '#8898aa', marginTop: '8px' }}>
                  {product.physical.stock} available
                </div>
              )}
            </div>
            
            {/* Shipping Section */}
            {product.type === 'physical' && product.physical?.shippingMethods && product.physical.shippingMethods.length > 0 && (
              <div className="shipping-section">
                <h4 style={{ fontSize: '14px', fontWeight: '600', color: '#32325d', marginBottom: '16px' }}>
                  Shipping Method
                </h4>
                <select
                  className="shipping-select"
                  value={selectedShipping}
                  onChange={(e) => setSelectedShipping(e.target.value)}
                >
                  {product.physical.shippingMethods.map((method, index) => (
                    <option key={index} value={method.name}>
                      {method.name} {method.price > 0 
                        ? `(${formatPrice(method.price, product.defaultCurrency)})` 
                        : '(Free)'}
                    </option>
                  ))}
                </select>
              </div>
            )}
            
            <button
              type="button"
              className="view-details-btn"
              onClick={() => setShowProductDetails(!showProductDetails)}
            >
              <span>{showProductDetails ? 'Hide details' : 'View details'}</span>
              <i className={`fas fa-chevron-down view-details-icon`}></i>
            </button>
            
            <div className="product-details">
              <div className="detail-row">
                <span className="detail-label">{product.title}</span>
                <span className="detail-value">
                  {formatPrice(displayPrice * quantity, displayCurrency)}
                </span>
              </div>
              
              {variantSelections.length > 0 && variantSelections.every(v => v.value) && (
                <div style={{ marginBottom: '12px' }}>
                  {variantSelections.map((selection, index) => (
                    <div key={index} style={{ fontSize: '12px', color: '#8898aa', marginBottom: '4px' }}>
                      {selection.name}: {selection.value}
                    </div>
                  ))}
                </div>
              )}
              
              <div className="detail-row">
                <span className="detail-label">Subtotal</span>
                <span className="detail-value">
                  {formatPrice(prices.subtotal, prices.currency)}
                </span>
              </div>
              
              {prices.vat > 0 && (
                <div className="detail-row">
                  <span className="detail-label">VAT</span>
                  <span className="detail-value">
                    {formatPrice(prices.vat, prices.currency)}
                  </span>
                </div>
              )}
              
              {prices.shipping > 0 && (
                <div className="detail-row">
                  <span className="detail-label">Shipping</span>
                  <span className="detail-value">
                    {formatPrice(prices.shipping, prices.currency)}
                  </span>
                </div>
              )}
              
              {prices.shipping === 0 && selectedShipping && (
                <div className="detail-row">
                  <span className="detail-label">Shipping</span>
                  <span className="detail-value" style={{ color: '#00d924' }}>Free</span>
                </div>
              )}
              
              <div className="detail-row total-row">
                <span className="detail-label">Total</span>
                <span className="detail-value">
                  {formatPrice(prices.total, prices.currency)}
                </span>
              </div>
              
              {/* Show original price if converted */}
              {displayCurrency !== product.defaultCurrency && (
                <div style={{ fontSize: '12px', color: '#8898aa', marginTop: '12px' }}>
                  Original: {formatPrice(initialProduct.price * quantity, initialProduct.defaultCurrency)}
                </div>
              )}
            </div>
            
            {product.longDescription && (
              <div style={{ marginTop: '30px' }}>
                <h4 style={{ fontSize: '14px', fontWeight: '600', color: '#32325d', marginBottom: '12px' }}>
                  Description
                </h4>
                <div style={{ fontSize: '13px', color: '#8898aa', lineHeight: '1.6' }}
                     dangerouslySetInnerHTML={{ __html: product.longDescription }} />
              </div>
            )}
          </div>
          
          {/* Payment Section */}
          <div className="payment-section">
            {errorMessage && (
              <div className="error-message">
                {errorMessage}
              </div>
            )}
            
            {!canPurchase && product.type === 'physical' ? (
              <div className="availability-message">
                This product is currently out of stock or unavailable with the selected options.
              </div>
            ) : canPurchase && !isLoading && transactionId && initialProduct ? (
              <PaymentForm
                currency={paymentDetails.currency}
                amount={paymentDetails.amount}
                transactionId={transactionId}
                onSubmit={handleSubmit}
                isSubmitting={isSubmitting}
                productOwnerId={initialProduct.merchantId || ''}
                productId={initialProduct._id}
                productName={initialProduct.title}
                quantity={quantity}
              />
            ) : null}
          </div>
        </div>
      </div>
    </>
  );
};

export default ProductDisplay;

ProductImages.tsx
// productcomponents/ProductImages.tsx
'use client';

import { useState } from 'react';
import { IImage } from '../productlib/types';

interface ProductImagesProps {
  images: IImage[];
}

const ProductImages: React.FC<ProductImagesProps> = ({ images }) => {
  // Find main image or use first image as default
  const mainImage = images.find(img => img.isMain) || images[0];
  const [selectedImage, setSelectedImage] = useState<string>(mainImage?.url || '');
  
  if (!images || images.length === 0) {
    return (
      <>
        <style jsx>{`
          .no-image-container {
            width: 100%;
            max-width: 200px;
            height: 150px;
            background: #f6f9fc;
            border-radius: 8px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e6ebf1;
          }
          
          .no-image-content {
            text-align: center;
            color: #8898aa;
          }
          
          .no-image-icon {
            font-size: 32px;
            margin-bottom: 8px;
            opacity: 0.5;
          }
          
          .no-image-text {
            font-size: 14px;
          }
        `}</style>
        
        <div className="no-image-container">
          <div className="no-image-content">
            <div className="no-image-icon">
              <i className="fas fa-image"></i>
            </div>
            <div className="no-image-text">No images available</div>
          </div>
        </div>
      </>
    );
  }

  // Format the image URL to ensure it starts with /api/uploads if needed
  const formatImageUrl = (url: string): string => {
    // If it's already a full URL, use it as-is
    if (url.startsWith('http')) {
      return url;
    }
    
    // Make sure URLs that start with /uploads have the proper /api prefix
    if (url.startsWith('/uploads') && !url.startsWith('/api/uploads')) {
      return `/api${url}`;
    }
    
    // URLs that already have /api/uploads are good
    if (url.startsWith('/api/uploads')) {
      return url;
    }
    
    // For all other cases, ensure it has the complete path
    return `/api/uploads/${url.replace(/^\//, '')}`;
  };

  return (
    <>
      <style jsx>{`
        .images-container {
          width: 100%;
        }
        
        .main-image {
          width: 100%;
          max-width: 200px;
          height: 150px;
          background: #f6f9fc;
          border-radius: 8px;
          margin: 0 auto 20px;
          overflow: hidden;
          border: 1px solid #e6ebf1;
          cursor: pointer;
        }
        
        .main-image img {
          width: 100%;
          height: 100%;
          object-fit: cover;
          transition: transform 0.3s ease;
        }
        
        .main-image:hover img {
          transform: scale(1.05);
        }
        
        .thumbnails {
          display: flex;
          gap: 8px;
          justify-content: center;
          flex-wrap: wrap;
          padding: 0 10px;
        }
        
        .thumbnail {
          width: 48px;
          height: 48px;
          border-radius: 6px;
          overflow: hidden;
          border: 2px solid transparent;
          cursor: pointer;
          transition: all 0.2s ease;
          background: #f6f9fc;
        }
        
        .thumbnail:hover {
          border-color: #cfd7df;
        }
        
        .thumbnail.active {
          border-color: #635bff;
          box-shadow: 0 0 0 2px rgba(99, 91, 255, 0.2);
        }
        
        .thumbnail img {
          width: 100%;
          height: 100%;
          object-fit: cover;
        }
        
        @media (max-width: 768px) {
          .main-image {
            max-width: 150px;
            height: 120px;
          }
          
          .thumbnail {
            width: 40px;
            height: 40px;
          }
        }
      `}</style>
      
      <div className="images-container">
        {/* Main image display */}
        <div className="main-image">
          <img
            src={formatImageUrl(selectedImage)}
            alt="Product"
          />
        </div>
        
        {/* Thumbnails */}
        {images.length > 1 && (
          <div className="thumbnails">
            {images.map((image, index) => (
              <button
                key={index}
                className={`thumbnail ${selectedImage === image.url ? 'active' : ''}`}
                onClick={() => setSelectedImage(image.url)}
                type="button"
              >
                <img
                  src={formatImageUrl(image.url)}
                  alt={`Thumbnail ${index + 1}`}
                />
              </button>
            ))}
          </div>
        )}
      </div>
    </>
  );
};

export default ProductImages;


QuantitySelector.tsx
// productcomponents/QuantitySelector.tsx
'use client';

import { useState } from 'react';
import { IProduct } from '../productlib/types';

interface QuantitySelectorProps {
  product: IProduct;
  quantity: number;
  onQuantityChange: (quantity: number) => void;
  maxQuantity?: number;
  minQuantity?: number;
}

const QuantitySelector: React.FC<QuantitySelectorProps> = ({
  product,
  quantity,
  onQuantityChange,
  maxQuantity = 99,
  minQuantity = 1
}) => {
  const [showMaxWarning, setShowMaxWarning] = useState(false);

  // Determine actual max quantity based on stock if applicable
  let actualMaxQuantity = maxQuantity;
  
  if (product.type === 'physical' && product.physical?.stock !== undefined) {
    actualMaxQuantity = Math.min(maxQuantity, product.physical.stock);
  }
  
  const handleQuantityChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const newQuantity = parseInt(e.target.value, 10);
    
    if (isNaN(newQuantity) || newQuantity < minQuantity) {
      onQuantityChange(minQuantity);
    } else if (newQuantity > actualMaxQuantity) {
      onQuantityChange(actualMaxQuantity);
      setShowMaxWarning(true);
      setTimeout(() => setShowMaxWarning(false), 2000);
    } else {
      onQuantityChange(newQuantity);
      setShowMaxWarning(false);
    }
  };

  const handleInputBlur = (e: React.FocusEvent<HTMLInputElement>) => {
    const newQuantity = parseInt(e.target.value, 10);
    
    if (isNaN(newQuantity) || newQuantity < minQuantity) {
      onQuantityChange(minQuantity);
    } else if (newQuantity > actualMaxQuantity) {
      onQuantityChange(actualMaxQuantity);
      setShowMaxWarning(true);
      setTimeout(() => setShowMaxWarning(false), 2000);
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    // Prevent entering non-numeric characters
    if (!/[0-9]/.test(e.key) && 
        !['Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
      e.preventDefault();
    }
  };
  
  const decreaseQuantity = () => {
    if (quantity > minQuantity) {
      onQuantityChange(quantity - 1);
      setShowMaxWarning(false);
    }
  };
  
  const increaseQuantity = () => {
    if (quantity < actualMaxQuantity) {
      onQuantityChange(quantity + 1);
    } else {
      setShowMaxWarning(true);
      setTimeout(() => setShowMaxWarning(false), 2000);
    }
  };
  
  return (
    <>
      <style jsx>{`
        .quantity-container {
          margin-bottom: 16px;
        }
        
        .quantity-label {
          display: block;
          font-size: 13px;
          font-weight: 500;
          color: #6b7c93;
          margin-bottom: 8px;
        }
        
        .quantity-controls {
          display: flex;
          align-items: center;
          gap: 0;
          border: 1px solid #cfd7df;
          border-radius: 4px;
          overflow: hidden;
          background: white;
          width: fit-content;
        }
        
        .quantity-btn {
          width: 40px;
          height: 40px;
          border: none;
          background: #f8f9fa;
          color: #32325d;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 16px;
          font-weight: 500;
          transition: background-color 0.15s ease;
          user-select: none;
        }
        
        .quantity-btn:hover:not(:disabled) {
          background: #e9ecef;
        }
        
        .quantity-btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
          background: #f8f9fa;
        }
        
        .quantity-btn:active:not(:disabled) {
          background: #dee2e6;
        }
        
        .quantity-btn.decrease {
          border-right: 1px solid #e6ebf1;
        }
        
        .quantity-btn.increase {
          border-left: 1px solid #e6ebf1;
        }
        
        .quantity-input {
          width: 60px;
          height: 40px;
          border: none;
          text-align: center;
          font-size: 16px;
          color: #32325d;
          background: white;
          outline: none;
          font-weight: 500;
          -moz-appearance: textfield; /* Firefox */
        }

        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        
        .quantity-input:focus {
          background: #f8f9fa;
        }

        .quantity-input:invalid {
          color: #ef4444;
        }
        
        .stock-info {
          font-size: 12px;
          color: #8898aa;
          margin-top: 8px;
        }
        
        .stock-warning {
          color: #f59e0b;
        }
        
        .stock-out {
          color: #ef4444;
        }

        .max-warning {
          color: #ef4444;
          font-size: 12px;
          margin-top: 4px;
          animation: fadeInOut 2s ease-in-out;
        }

        @keyframes fadeInOut {
          0% { opacity: 0; transform: translateY(-5px); }
          20% { opacity: 1; transform: translateY(0); }
          80% { opacity: 1; transform: translateY(0); }
          100% { opacity: 0; transform: translateY(-5px); }
        }
      `}</style>
      
      <div className="quantity-container">
        <label className="quantity-label">Quantity</label>
        <div className="quantity-controls">
          <button
            type="button"
            className="quantity-btn decrease"
            onClick={decreaseQuantity}
            disabled={quantity <= minQuantity}
          >
            −
          </button>
          <input
            type="number"
            className="quantity-input"
            min={minQuantity}
            max={actualMaxQuantity}
            value={quantity}
            onChange={handleQuantityChange}
            onBlur={handleInputBlur}
            onKeyDown={handleKeyDown}
          />
          <button
            type="button"
            className="quantity-btn increase"
            onClick={increaseQuantity}
            disabled={quantity >= actualMaxQuantity}
          >
            +
          </button>
        </div>
        
        {showMaxWarning && (
          <div className="max-warning">
            Maximum quantity is {actualMaxQuantity}
          </div>
        )}
        
        {product.type === 'physical' && product.physical?.stock !== undefined && (
          <div className={`stock-info ${
            product.physical.stock === 0 ? 'stock-out' : 
            product.physical.stock < 10 ? 'stock-warning' : ''
          }`}>
            {product.physical.stock === 0 ? 'Out of stock' :
             product.physical.stock < 10 ? `Only ${product.physical.stock} left in stock` :
             `${product.physical.stock} available`}
          </div>
        )}
      </div>
    </>
  );
};

export default QuantitySelector;

VariantSelector.tsx
// productcomponents/VariantSelector.tsx
'use client';

import { useState, useEffect } from 'react';
import { IVariant, IVariantSelection } from '../productlib/types';

interface VariantSelectorProps {
  variants: IVariant[];
  onVariantSelect: (selections: IVariantSelection[]) => void;
}

const VariantSelector: React.FC<VariantSelectorProps> = ({ variants, onVariantSelect }) => {
  const [selections, setSelections] = useState<IVariantSelection[]>([]);
  
  // Initialize with empty selections
  useEffect(() => {
    if (variants && variants.length > 0) {
      // Create initial selections with empty values
      const initialSelections = variants.map(variant => ({
        name: variant.name,
        value: '',
      }));
      setSelections(initialSelections);
    }
  }, [variants]);
  
  // Update parent component when selections change
  useEffect(() => {
    if (selections.length > 0) {
      onVariantSelect(selections);
    }
  }, [selections, onVariantSelect]);
  
  if (!variants || variants.length === 0) {
    return null;
  }
  
  const handleVariantChange = (variantName: string, value: string) => {
    const newSelections = selections.map(selection => 
      selection.name === variantName 
        ? { ...selection, value } 
        : selection
    );
    setSelections(newSelections);
  };
  
  return (
    <>
      <style jsx>{`
        .variants-container {
          margin-bottom: 20px;
        }
        
        .variants-title {
          font-size: 14px;
          font-weight: 600;
          color: #32325d;
          margin-bottom: 16px;
        }
        
        .variant-group {
          margin-bottom: 16px;
        }
        
        .variant-group:last-child {
          margin-bottom: 0;
        }
        
        .variant-label {
          display: block;
          font-size: 13px;
          font-weight: 500;
          color: #6b7c93;
          margin-bottom: 8px;
        }
        
        .variant-select {
          width: 100%;
          padding: 12px;
          border: 1px solid #cfd7df;
          border-radius: 4px;
          font-size: 16px;
          color: #32325d;
          background: white;
          appearance: none;
          cursor: pointer;
          transition: border-color 0.15s ease, box-shadow 0.15s ease;
          background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%238898aa' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
          background-position: right 12px center;
          background-repeat: no-repeat;
          background-size: 16px;
          padding-right: 40px;
        }
        
        .variant-select:focus {
          outline: none;
          border-color: #635bff;
          box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.2);
        }
        
        .variant-select:hover {
          border-color: #aab7c4;
        }
        
        .variant-select option {
          color: #32325d;
          background: white;
          padding: 8px;
        }
        
        .variant-select option:disabled {
          color: #8898aa;
        }
        
        .variant-select:invalid {
          color: #aab7c4;
        }
        
        .stock-indicator {
          font-size: 12px;
          color: #8898aa;
          margin-top: 4px;
        }
        
        .stock-low {
          color: #f59e0b;
        }
        
        .stock-out {
          color: #ef4444;
        }
      `}</style>
      
      <div className="variants-container">
        <div className="variants-title">Product Options</div>
        {variants.map((variant, index) => {
          const currentSelection = selections.find(s => s.name === variant.name);
          
          return (
            <div key={index} className="variant-group">
              <label className="variant-label">{variant.name}</label>
              <select
                className="variant-select"
                value={currentSelection?.value || ''}
                onChange={(e) => handleVariantChange(variant.name, e.target.value)}
              >
                <option value="" disabled>
                  Select {variant.name}
                </option>
                {variant.values.map((value, valueIndex) => (
                  <option key={valueIndex} value={value}>
                    {value}
                  </option>
                ))}
              </select>
              
              {/* Stock indicator for variant */}
              {variant.stock !== undefined && (
                <div className={`stock-indicator ${
                  variant.stock === 0 ? 'stock-out' : 
                  variant.stock < 5 ? 'stock-low' : ''
                }`}>
                  {variant.stock === 0 ? 'Out of stock' :
                   variant.stock < 5 ? `Only ${variant.stock} left` :
                   `${variant.stock} in stock`}
                </div>
              )}
            </div>
          );
        })}
      </div>
    </>
  );
};

export default VariantSelector;

